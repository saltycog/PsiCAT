name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.2.3)'
        required: true
        type: string

permissions:
  contents: write
  packages: write

jobs:
  check-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest release tag
        id: latest-tag
        uses: actions-ecosystem/action-get-latest-tag@v1
        with:
          initial_version: v0.0.0

      - name: Display latest release
        run: |
          echo "Latest release tag: ${{ steps.latest-tag.outputs.tag }}"

      - name: Validate release version format
        id: validate-version
        uses: matt-usurp/validate-semver@v2
        with:
          version: ${{ github.event.inputs.version }}

      - name: Validate version increment
        run: |
          VERSION="${{ github.event.inputs.version }}"
          LATEST_VERSION="${{ steps.latest-tag.outputs.tag }}"

          # If first release, allow any valid semver
          if [ "$LATEST_VERSION" = "v0.0.0" ]; then
            echo "✓ No previous releases - first release allowed"
            exit 0
          fi

          # Parse versions (remove v prefix)
          NEW_VERSION="${VERSION#v}"
          OLD_VERSION="${LATEST_VERSION#v}"

          # Split versions into major.minor.patch using parameter expansion
          NEW_MAJOR="${NEW_VERSION%%.*}"
          NEW_TEMP="${NEW_VERSION#*.}"
          NEW_MINOR="${NEW_TEMP%%.*}"
          NEW_PATCH="${NEW_TEMP##*.}"

          OLD_MAJOR="${OLD_VERSION%%.*}"
          OLD_TEMP="${OLD_VERSION#*.}"
          OLD_MINOR="${OLD_TEMP%%.*}"
          OLD_PATCH="${OLD_TEMP##*.}"

          # Force base-10 interpretation to avoid octal issues
          NEW_MAJOR=$((10#$NEW_MAJOR))
          NEW_MINOR=$((10#$NEW_MINOR))
          NEW_PATCH=$((10#$NEW_PATCH))
          OLD_MAJOR=$((10#$OLD_MAJOR))
          OLD_MINOR=$((10#$OLD_MINOR))
          OLD_PATCH=$((10#$OLD_PATCH))

          # Compare: if new > old in any part (major first, then minor, then patch)
          if (( NEW_MAJOR > OLD_MAJOR || (NEW_MAJOR == OLD_MAJOR && NEW_MINOR > OLD_MINOR) || (NEW_MAJOR == OLD_MAJOR && NEW_MINOR == OLD_MINOR && NEW_PATCH > OLD_PATCH) )); then
            echo "✓ Version increment valid: $LATEST_VERSION → $VERSION"
            exit 0
          fi

          echo "❌ Version must be greater than the latest release ($LATEST_VERSION)"
          exit 1

      - name: Check for differences between main and latest release
        run: |
          LATEST_TAG="${{ steps.latest-tag.outputs.tag }}"

          if [ "$LATEST_TAG" = "v0.0.0" ]; then
            echo "✓ No previous releases - proceeding with initial release"
            exit 0
          fi

          LATEST_COMMIT=$(git rev-list -n 1 "$LATEST_TAG" 2>/dev/null || echo "")
          MAIN_COMMIT=$(git rev-parse origin/main)

          if [ "$LATEST_COMMIT" = "$MAIN_COMMIT" ]; then
            echo "❌ Release failed: main has not changed since $LATEST_TAG"
            exit 1
          fi

          echo "✓ main branch has changed since last release ($LATEST_TAG)"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build project
        run: dotnet build -c Release

      - name: Push version tag
        uses: actions-ecosystem/action-push-tag@v1
        with:
          tag: ${{ github.event.inputs.version }}
          message: 'Release ${{ github.event.inputs.version }}'

      - name: Set Docker image repository (lowercase)
        id: docker-repo
        run: |
          echo "repo=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ steps.docker-repo.outputs.repo }}:${{ github.event.inputs.version }}
            ghcr.io/${{ steps.docker-repo.outputs.repo }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
